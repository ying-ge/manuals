name: Scrape medRxiv AI Articles

on:
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:  # Allow manual trigger for immediate runs
    inputs:
      search_keyword:
        description: 'Search keyword (default: artificial intelligence)'
        required: false
        default: 'artificial intelligence'
      days_back:
        description: 'Days to look back (default: 30, use 365 for full 2025)'
        required: false
        default: '30'

permissions:
  contents: write
  pull-requests: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create necessary directories
        run: |
          mkdir -p data logs .cache
      
      - name: Run harvest script
        env:
          GLM_API_KEY: ${{ secrets.GLM_API_KEY }}
          GLM_BASE_URL: ${{ secrets.GLM_BASE_URL }}
          GLM_MODEL_NAME: ${{ secrets.GLM_MODEL_NAME }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          BIO_MODEL_API_KEY: ${{ secrets.BIO_MODEL_API_KEY }}
          BIO_MODEL_BASE_URL: ${{ secrets.BIO_MODEL_BASE_URL }}
          SEARCH_KEYWORD: ${{ github.event.inputs.search_keyword || 'artificial intelligence' }}
          DAYS_BACK: ${{ github.event.inputs.days_back || '30' }}
        run: |
          python src/harvest_medrxiv.py
      
      - name: Get timestamp for branch name
        id: timestamp
        run: echo "timestamp=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'data: Add medRxiv AI articles harvest ${{ steps.timestamp.outputs.timestamp }}'
          branch: data/harvest-${{ steps.timestamp.outputs.timestamp }}
          delete-branch: true
          title: 'medRxiv AI Articles - ${{ steps.timestamp.outputs.timestamp }}'
          body: |
            ## medRxiv AI Article Harvest Results
            
            **Harvest Time:** ${{ steps.timestamp.outputs.timestamp }} UTC
            
            This PR contains the results of the automated medRxiv article harvest for AI-related papers.
            
            ### Files Added
            
            - `data/medrxiv-ai-${{ steps.timestamp.outputs.timestamp }}.json` - Full article data
            - `data/medrxiv-ai-${{ steps.timestamp.outputs.timestamp }}.md` - Human-readable report
            - `data/medrxiv-ai-${{ steps.timestamp.outputs.timestamp }}-summary.json` - Statistics summary
            
            ### Next Steps
            
            1. Review the summary file for statistics
            2. Check for articles marked as `needs_manual_review`
            3. Verify the extracted information is accurate
            4. Merge if everything looks good
            
            ### Configuration
            
            - **Search Keyword:** artificial intelligence
            - **Time Window:** Last 30 days
            - **Maximum Articles:** 200
            
            ---
            *This PR was automatically generated by the medRxiv harvester workflow*
          labels: |
            automated
            data
      
      - name: Upload logs as artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: harvest-logs-${{ steps.timestamp.outputs.timestamp }}
          path: logs/
          retention-days: 30
